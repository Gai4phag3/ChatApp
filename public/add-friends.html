<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Friends</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #userList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      cursor: default;
      transition: background-color 0.2s;
    }
    #userList li:hover {
      background-color: var(--hover);
    }
    #userList button {
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 20px;
      border: none;
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }
    #userList button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Add Friends</h2>
    <input type="text" id="search" placeholder="Search usernames or names..." />
    <ul id="userList"></ul>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    const currentUsername = localStorage.getItem("username");
    if (!currentUsername) {
      alert("You're not logged in!");
      window.location.href = "login.html";
    }

    const searchInput = document.getElementById("search");
    const userList = document.getElementById("userList");
    let currentFriends = [];
    let allUsers = [];

    async function loadFriendsAndUsers() {
      try {
        const userDoc = await db.collection("users").doc(currentUsername).get();
        if (!userDoc.exists) {
          alert("Current user not found.");
          return;
        }

        currentFriends = userDoc.data().friends || [];

        const snapshot = await db.collection("users").get();
        allUsers = [];

        snapshot.forEach(doc => {
          const username = doc.id;
          if (username !== currentUsername && !currentFriends.includes(username)) {
            allUsers.push({
    displayUsers(allUsers);
  } catch (err) {
    console.error(err);
    alert("Failed to load users.");
  }
}

function displayUsers(users) {
  userList.innerHTML = "";
  users.forEach(user => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div>
        <strong>${user.name}</strong><br><small>@${user.username}</small>
      </div>
      <button onclick="addFriend('${user.username}')">Add</button>
    `;
    userList.appendChild(li);
  });
}

async function addFriend(friendUsername) {
  try {
    await db.collection("users").doc(currentUsername).update({
      friends: firebase.firestore.FieldValue.arrayUnion(friendUsername)
    });
    alert("Friend added!");
    loadFriendsAndUsers();
  } catch (err) {
    console.error(err);
    alert("Failed to add friend.");
  }
}

searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  const filtered = allUsers.filter(user =>
    user.name.toLowerCase().includes(query) ||
    user.username.toLowerCase().includes(query)
  );
  displayUsers(filtered);
});

loadFriendsAndUsers();
