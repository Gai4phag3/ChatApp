<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="icon" href="/favicon.png" type="image/x-icon" />
  
  <!-- Font Awesome CDN for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-papbR6Y63PqH7zAGpS0eDlR4xzQc9fWjRcwJ7zPfp0RV67Q4QX8N6tBk1lLxiVRxliwtEl1HsYNezXyI6x2Mzw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  
  <link rel="stylesheet" href="dash.css" />

  <!-- Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <style>
    /* Modal Styles */
    #profileModal {
      display: none;
      position: fixed; 
      z-index: 9999; 
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; 
      background-color: rgba(0,0,0,0.5);
    }

    #profileModalContent {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }

    #profileModalContent h3 {
      margin-top: 0;
      text-align: center;
    }

    #profile-pic-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ccc;
      display: block;
      margin: 0 auto 15px auto;
    }

    #profileModalClose {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #888;
      transition: color 0.3s ease;
    }

    #profileModalClose:hover {
      color: #444;
    }

    #upload-profile-pic {
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    #upload-profile-pic:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    #upload-status {
      margin-top: 10px;
      text-align: center;
      font-weight: bold;
    }

    /* Adjust top buttons layout */
    .top-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .top-buttons button {
      flex: 1;
      min-width: 120px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="username-display"></span>! ðŸ˜Š</h2>

    <div class="top-buttons">
      <button onclick="goToAddFriends()" class="add"><i class="fa-solid fa-user-plus"></i> Add Friends</button>
      <button onclick="goToSettings()" class="settings"><i class="fa-solid fa-gear"></i> Settings</button>
      <button onclick="logout()" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      <button id="openProfileBtn" class="profile"><i class="fa-solid fa-user"></i> Profile</button>
    </div>

    <h3>Your Friends</h3>
    <div id="friend-list"></div>

    <h3>Friend Requests</h3>
    <div id="friend-requests"></div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal">
    <div id="profileModalContent">
      <span id="profileModalClose">&times;</span>
      <h3>Your Profile Picture</h3>
      <img
        id="profile-pic-preview"
        src="default-profile.png"
        alt="Profile Picture"
      />
      <input type="file" id="profile-pic-input" accept="image/*" />
      <button id="upload-profile-pic" disabled>Upload</button>
      <p id="upload-status"></p>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const currentUser = localStorage.getItem("username");
    if (!currentUser) {
      alert("No user logged in. Redirecting to login...");
      window.location.href = "index.html";
    }

    document.getElementById("username-display").textContent = currentUser;

    const friendList = document.getElementById("friend-list");
    const friendRequestsDiv = document.getElementById("friend-requests");

    // Profile modal elements
    const profileModal = document.getElementById("profileModal");
    const openProfileBtn = document.getElementById("openProfileBtn");
    const closeProfileBtn = document.getElementById("profileModalClose");
    const profilePicInput = document.getElementById("profile-pic-input");
    const profilePicPreview = document.getElementById("profile-pic-preview");
    const uploadButton = document.getElementById("upload-profile-pic");
    const uploadStatus = document.getElementById("upload-status");

    let selectedFile = null;

    // Open modal
    openProfileBtn.onclick = () => {
      uploadStatus.textContent = "";
      uploadButton.disabled = true;
      profilePicInput.value = null;
      selectedFile = null;
      profileModal.style.display = "block";
    };

    // Close modal
    closeProfileBtn.onclick = () => {
      profileModal.style.display = "none";
    };

    // Close modal when clicking outside content
    window.onclick = (event) => {
      if (event.target == profileModal) {
        profileModal.style.display = "none";
      }
    };

    // File input change
    profilePicInput.addEventListener("change", (e) => {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        const reader = new FileReader();
        reader.onload = (event) => {
          profilePicPreview.src = event.target.result;
          uploadButton.disabled = false;
          uploadStatus.textContent = "";
        };
        reader.readAsDataURL(selectedFile);
      } else {
        uploadButton.disabled = true;
        uploadStatus.textContent = "";
      }
    });

    // Upload to Firebase Storage
    uploadButton.addEventListener("click", () => {
      if (!selectedFile) {
        alert("Please select an image first!");
        return;
      }

      uploadStatus.style.color = "black";
      uploadStatus.textContent = "Uploading...";
      uploadButton.disabled = true;

      const storageRef = firebase.storage().ref();
      const userPicRef = storageRef.child(`profile_pictures/${currentUser}.jpg`);

      userPicRef
        .put(selectedFile)
        .then((snapshot) => snapshot.ref.getDownloadURL())
        .then((downloadURL) => {
          return db
            .collection("users")
            .doc(currentUser)
            .set({ profilePicURL: downloadURL }, { merge: true })
            .then(() => downloadURL);
        })
        .then((downloadURL) => {
          profilePicPreview.src = downloadURL;
          uploadStatus.style.color = "green";
          uploadStatus.textContent = "Upload successful!";
        })
        .catch((err) => {
          console.error("Upload failed:", err);
          uploadStatus.style.color = "red";
          uploadStatus.textContent = "Upload failed.";
        })
        .finally(() => {
          uploadButton.disabled = false;
        });
    });

    // Load existing profile pic on page load
    db.collection("users")
      .doc(currentUser)
      .get()
      .then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          if (data.profilePicURL) {
            profilePicPreview.src = data.profilePicURL;
          }
        }
      });

    // Load Friends and Friend Requests (same as before)
    function loadFriends() {
      friendList.innerHTML = "";

      db.collection("friends")
        .where("user", "==", currentUser)
        .where("accepted", "==", true)
        .onSnapshot((snapshot) => {
          friendList.innerHTML = "";

          if (snapshot.empty) {
            friendList.innerHTML = "<p>You have no friends yet. Add some! ðŸŒŸ</p>";
            return;
          }

          snapshot.forEach((doc) => {
            const friendUsername = doc.data().friend;

            db.collection("users")
              .doc(friendUsername)
              .get()
              .then((friendDoc) => {
                const friendName = friendDoc.exists
                  ? friendDoc.data().name || friendUsername
                  : friendUsername;

                const btn = document.createElement("button");
                btn.className = "friend-button";
                btn.innerHTML = `
                  ${friendName}
                  <span class="notif" id="notif-${friendUsername}">0</span>
                `;
                btn.onclick = () => openChatWith(friendUsername);

                friendList.appendChild(btn);

                watchUnreadMessages(friendUsername);
              });
          });
        });
    }

    function loadFriendRequests() {
      friendRequestsDiv.innerHTML = "";
      db.collection("friends")
        .where("friend", "==", currentUser)
        .where("accepted", "==", false)
        .get()
        .then((snapshot) => {
          if (snapshot.empty) {
            friendRequestsDiv.innerHTML = "<p>No friend requests. You're popular! ðŸŽ‰</p>";
            return;
          }

          snapshot.forEach((doc) => {
            const requesterUsername = doc.data().user;

            const div = document.createElement("div");
            div.textContent = requesterUsername;

            const acceptBtn = document.createElement("button");
            acceptBtn.innerHTML = '<i class="fa-solid fa-check"></i> Accept';
            acceptBtn.onclick = () => acceptFriendRequest(doc.id, requesterUsername);

            div.appendChild(acceptBtn);
            friendRequestsDiv.appendChild(div);
          });
        })
        .catch((err) => {
          console.error("Error loading friend requests:", err);
          friendRequestsDiv.innerHTML = "<p>Error loading friend requests.</p>";
        });
    }

    function acceptFriendRequest(requestDocId, requesterUsername) {
      db.collection("friends")
        .doc(requestDocId)
        .update({ accepted: true })
        .then(() => {
          return db.collection("friends").add({
            user: currentUser,
            friend: requesterUsername,
            accepted: true,
          });
        })
        .then(() => {
          alert("Friend request accepted! ðŸŽ‰");
          loadFriendRequests();
          loadFriends();
        })
        .catch((err) => {
          console.error("Error accepting friend request:", err);
          alert("Failed to accept friend request.");
        });
    }

    function openChatWith(friendUsername) {
      const chatId = [currentUser, friendUsername].sort().join("_");

      db.collection("lastRead").doc(chatId + "_" + currentUser).set({ lastRead: Date.now() });

      localStorage.setItem("chatWith", friendUsername);
      window.location.href = "chat.html";
    }

    function watchUnreadMessages(friendUsername) {
      const chatId = [currentUser, friendUsername].sort().join("_");

      db.collection("lastRead")
        .doc(chatId + "_" + currentUser)
        .onSnapshot((lastReadDoc) => {
          const lastRead = lastReadDoc.exists ? lastReadDoc.data().lastRead : 0;

          db.collection("chats")
            .doc(chatId)
            .collection("messages")
            .orderBy("timestamp", "desc")
            .limit(1)
            .onSnapshot((snapshot) => {
              snapshot.forEach((doc) => {
                const data = doc.data();
                const notifEl = document.getElementById(`notif-${friendUsername}`);
                if (!notifEl) return;

                if (data.sender !== currentUser && data.timestamp > lastRead) {
                  notifEl.style.display = "inline-block";
                  notifEl.textContent = "1";
                } else {
                  notifEl.style.display = "none";
                }
              });
            });
        });
    }

    function goToAddFriends() {
      window.location.href = "add-friends.html";
    }

    function goToSettings() {
      window.location.href = "settings.html";
    }

    function logout() {
      localStorage.removeItem("username");
      localStorage.removeItem("chatWith");
      window.location.href = "index.html";
    }

    loadFriends();
    loadFriendRequests();
  </script>
</body>
</html>
