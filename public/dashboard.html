<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="icon" href="/favicon.png" type="image/x-icon" />
  
  <!-- Font Awesome CDN for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
  
  <link rel="stylesheet" href="dash.css" />

  <style>
    /* Basic styles for profile modal */
    #profile-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 28px;
      margin-left: 10px;
      vertical-align: middle;
      user-select: none;
      color: #00796b;
      transition: color 0.3s ease;
    }
    #profile-btn:hover {
      color: #004d40;
    }
    #profile-display-name {
      font-weight: 600;
      margin-left: 6px;
      color: #004d40;
      vertical-align: middle;
    }
    #profile-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    #profile-modal.active {
      display: flex;
    }
    #profile-modal > div {
      background: white;
      border-radius: 16px;
      padding: 30px;
      width: 320px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    #profile-emoji {
      font-size: 64px;
      margin-bottom: 20px;
      user-select: none;
    }
    #profile-modal label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #004d40;
      user-select: none;
      text-align: left;
    }
    #profile-modal select, #profile-modal input[type="text"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #00796b;
      font-size: 16px;
      width: 100%;
      margin-bottom: 20px;
      box-sizing: border-box;
      user-select: none;
      cursor: pointer;
    }
    #profile-modal button {
      padding: 10px 22px;
      border: none;
      border-radius: 24px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      margin-top: 12px;
      user-select: none;
      color: white;
      background: linear-gradient(135deg, #26a69a, #00796b);
      box-shadow: 0 6px 20px rgba(38,166,154,0.5);
      transition: background 0.25s ease;
    }
    #profile-modal button#close-profile-btn {
      background: #ef5350;
      margin-left: 10px;
      box-shadow: 0 6px 20px rgba(239,83,80,0.5);
    }
    #profile-modal button:hover {
      filter: brightness(1.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="username-display"></span>! 
      <button id="profile-btn" title="Edit Profile" aria-label="Edit Profile">üë§</button>
      <span id="profile-display-name"></span>
      <span id="profile-emoji-display" style="font-size:28px; margin-left:8px;"></span>
    </h2>

    <div class="top-buttons">
      <button onclick="goToAddFriends()" class="add"><i class="fa-solid fa-user-plus"></i> Add Friends</button>
      <button onclick="goToSettings()" class="settings"><i class="fa-solid fa-gear"></i> Settings</button>
      <button onclick="logout()" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>

    <h3>Your Friends</h3>
    <div id="friend-list"></div>

    <h3>Friend Requests</h3>
    <div id="friend-requests"></div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
    <div>
      <h3 id="profile-modal-title">Edit Your Profile</h3>
      <div id="profile-emoji">üë§</div>

      <label for="emoji-select">Choose your avatar emoji:</label>
      <select id="emoji-select" aria-describedby="emoji-desc">
        <option value="üë§">üë§ Default</option>
        <option value="üòé">üòé Cool</option>
        <option value="ü§†">ü§† Cowboy</option>
        <option value="ü¶∏">ü¶∏ Superhero</option>
        <option value="üê±">üê± Cat</option>
        <option value="üêµ">üêµ Monkey</option>
        <option value="üëΩ">üëΩ Alien</option>
        <option value="ü§ñ">ü§ñ Robot</option>
        <option value="üßô">üßô Wizard</option>
      </select>
      
      <label for="display-name-input">Display Name:</label>
      <input type="text" id="display-name-input" placeholder="Enter display name" maxlength="30" />

      <button id="save-profile-btn">Save Profile</button>
      <button id="close-profile-btn">Cancel</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const currentUser = localStorage.getItem("username");
    if (!currentUser) {
      alert("No user logged in. Redirecting to login...");
      window.location.href = "index.html";
    }

    const db = firebase.firestore();

    const usernameDisplay = document.getElementById("username-display");
    const profileBtn = document.getElementById("profile-btn");
    const profileModal = document.getElementById("profile-modal");
    const profileEmojiDiv = document.getElementById("profile-emoji");
    const emojiSelect = document.getElementById("emoji-select");
    const displayNameInput = document.getElementById("display-name-input");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const closeProfileBtn = document.getElementById("close-profile-btn");
    const profileDisplayNameSpan = document.getElementById("profile-display-name");
    const profileEmojiDisplaySpan = document.getElementById("profile-emoji-display");

    // Load user profile info from Firestore and display
    function loadUserProfile() {
      db.collection("users").doc(currentUser).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          const displayName = data.displayName || currentUser;
          const emoji = data.emoji || "üë§";
          
          usernameDisplay.textContent = displayName;
          profileDisplayNameSpan.textContent = ""; // We use usernameDisplay for name now
          profileEmojiDisplaySpan.textContent = emoji;
        } else {
          usernameDisplay.textContent = currentUser;
          profileEmojiDisplaySpan.textContent = "üë§";
        }
      }).catch(err => {
        console.error("Failed to load profile:", err);
        usernameDisplay.textContent = currentUser;
        profileEmojiDisplaySpan.textContent = "üë§";
      });
    }

    // Open modal and prefill fields
    function openProfileModal() {
      db.collection("users").doc(currentUser).get().then(doc => {
        let emoji = "üë§";
        let displayName = currentUser;
        if (doc.exists) {
          emoji = doc.data().emoji || emoji;
          displayName = doc.data().displayName || displayName;
        }
        emojiSelect.value = emoji;
        displayNameInput.value = displayName;
        profileEmojiDiv.textContent = emoji;
        profileModal.classList.add("active");
        displayNameInput.focus();
      });
    }

    // Close modal
    function closeProfileModal() {
      profileModal.classList.remove("active");
    }

    // Update emoji preview on select change
    emojiSelect.addEventListener("change", () => {
      profileEmojiDiv.textContent = emojiSelect.value;
    });

    // Save profile data to Firestore
    saveProfileBtn.addEventListener("click", () => {
      const newEmoji = emojiSelect.value;
      const newDisplayName = displayNameInput.value.trim();

      if (!newDisplayName) {
        alert("Display name cannot be empty.");
        displayNameInput.focus();
        return;
      }

      db.collection("users").doc(currentUser).set({
        emoji: newEmoji,
        displayName: newDisplayName
      }, { merge: true })
      .then(() => {
        alert("Profile saved!");
        loadUserProfile();
        closeProfileModal();
      })
      .catch(err => {
        console.error("Failed to save profile:", err);
        alert("Failed to save profile. Please try again.");
      });
    });

    closeProfileBtn.addEventListener("click", closeProfileModal);
    profileBtn.addEventListener("click", openProfileModal);

    // Existing code from your original script for friends and requests...

    const friendList = document.getElementById("friend-list");
    const friendRequestsDiv = document.getElementById("friend-requests");

    function loadFriends() {
      friendList.innerHTML = "";

      db.collection("friends")
        .where("user", "==", currentUser)
        .where("accepted", "==", true)
        .onSnapshot(snapshot => {
          friendList.innerHTML = "";

          if (snapshot.empty) {
            friendList.innerHTML = "<p>You have no friends yet. Add some! üåü</p>";
            return;
          }

          snapshot.forEach(doc => {
            const friendUsername = doc.data().friend;

            db.collection("users").doc(friendUsername).get().then(friendDoc => {
              const friendName = friendDoc.exists ? (friendDoc.data().displayName || friendUsername) : friendUsername;

              const btn = document.createElement("button");
              btn.className = "friend-button";
              btn.innerHTML = `
                ${friendName}
                <span class="notif" id="notif-${friendUsername}">0</span>
              `;
              btn.onclick = () => openChatWith(friendUsername);

              friendList.appendChild(btn);

              watchUnreadMessages(friendUsername);
            });
          });
        });
    }

    function loadFriendRequests() {
      friendRequestsDiv.innerHTML = "";
      db.collection("friends")
        .where("friend", "==", currentUser)
        .where("accepted", "==", false)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            friendRequestsDiv.innerHTML = "<p>No friend requests. You're popular! üéâ</p>";
            return;
          }

          snapshot.forEach(doc => {
            const requesterUsername = doc.data().user;

            const div = document.createElement("div");
            div.textContent = requesterUsername;

            const acceptBtn = document.createElement("button");
            acceptBtn.innerHTML = '<i class="fa-solid fa-check"></i> Accept';
            acceptBtn.onclick = () => acceptFriendRequest(doc.id, requesterUsername);

            div.appendChild(acceptBtn);
            friendRequestsDiv.appendChild(div);
          });
        })
        .catch(err => {
          console.error("Error loading friend requests:", err);
          friendRequestsDiv.innerHTML = "<p>Error loading friend requests.</p>";
        });
    }

    function acceptFriendRequest(requestDocId, requesterUsername) {
      db.collection("friends")
        .doc(requestDocId)
        .update({ accepted: true })
        .then(() => {
          return db.collection("friends").add({
            user: currentUser,
            friend: requesterUsername,
            accepted: true
          });
        })
        .then(() => {
          alert("Friend request accepted! üéâ");
          loadFriendRequests();
          loadFriends();
        })
        .catch(err => {
          console.error("Error accepting friend request:", err);
          alert("Failed to accept friend request.");
        });
    }

    function openChatWith(friendUsername) {
      const chatId = [currentUser, friendUsername].sort().join('_');

      db.collection("lastRead")
        .doc(chatId + "_" + currentUser)
        .set({ lastRead: Date.now() });

      localStorage.setItem("chatWith", friendUsername);
      window.location.href = "chat.html";
    }

    function watchUnreadMessages(friendUsername) {
      const chatId = [currentUser, friendUsername].sort().join('_');

      db.collection("lastRead")
        .doc(chatId + "_" + currentUser)
        .onSnapshot(lastReadDoc => {
          const lastRead = lastReadDoc.exists ? lastReadDoc.data().lastRead : 0;

          db.collection("chats")
            .doc(chatId)
            .collection("messages")
            .orderBy("timestamp", "desc")
            .limit(1)
            .onSnapshot(snapshot => {
              snapshot.forEach(doc => {
                const data = doc.data();
                const notifEl = document.getElementById(`notif-${friendUsername}`);
                if (!notifEl) return;

                if (data.sender !== currentUser && data.timestamp > lastRead) {
                  notifEl.style.display = "inline-block";
                  notifEl.textContent = "1";
                } else {
                  notifEl.style.display = "none";
                }
              });
            });
        });
    }

    function goToAddFriends() {
      window.location.href = "add-friends.html";
    }

    function goToSettings() {
      window.location.href = "settings.html";
    }

    function logout() {
      localStorage.removeItem("username");
      localStorage.removeItem("chatWith");
      window.location.href = "index.html";
    }

    // Initial loading
    loadUserProfile();
    loadFriends();
    loadFriendRequests();

  </script>
</body>
</html>
