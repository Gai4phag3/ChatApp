<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }

    .friend-button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .friend-button:hover {
      background-color: #2980b9;
    }

    .top-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .top-buttons button {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .top-buttons button.logout {
      background-color: #e74c3c;
    }

    .top-buttons button:hover {
      opacity: 0.9;
    }

    /* Friend Requests styles */
    #friend-requests > div {
      margin-bottom: 10px;
    }
    #friend-requests button {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #27ae60;
      color: white;
    }
    #friend-requests button:hover {
      background-color: #1e8449;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="username-display"></span>!</h2>

    <div class="top-buttons">
      <button onclick="goToAddFriends()">âž• Add Friends</button>
      <button onclick="logout()" class="logout">Logout</button>
    </div>

    <h3>Your Friends</h3>
    <div id="friend-list"></div>

    <h3>Friend Requests</h3>
    <div id="friend-requests"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const currentUser = localStorage.getItem("username");
    if (!currentUser) {
      alert("No user logged in. Redirecting to login...");
      window.location.href = "index.html";
    }

    document.getElementById("username-display").textContent = currentUser;

    const friendList = document.getElementById("friend-list");
    const friendRequestsDiv = document.getElementById("friend-requests");

    function loadFriends() {
      friendList.innerHTML = "";
      db.collection("friends")
        .where("user", "==", currentUser)
        .where("accepted", "==", true)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            friendList.innerHTML = "<p>You have no friends yet. Add some!</p>";
            return;
          }

          snapshot.forEach(doc => {
            const friendUsername = doc.data().friend;

            // Optionally get friend's display name
            db.collection("users").doc(friendUsername).get().then(friendDoc => {
              const friendName = friendDoc.exists ? (friendDoc.data().name || friendUsername) : friendUsername;

              const btn = document.createElement("button");
              btn.className = "friend-button";
              btn.textContent = friendName;
              btn.onclick = () => openChatWith(friendUsername);
              friendList.appendChild(btn);
            });
          });
        })
        .catch(err => {
          console.error("Failed to load friends:", err);
          friendList.innerHTML = "<p>Error loading friends.</p>";
        });
    }

    function loadFriendRequests() {
      friendRequestsDiv.innerHTML = "";
      db.collection("friends")
        .where("friend", "==", currentUser)
        .where("accepted", "==", false)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            friendRequestsDiv.innerHTML = "<p>No friend requests.</p>";
            return;
          }

          snapshot.forEach(doc => {
            const requesterUsername = doc.data().user;

            const div = document.createElement("div");
            div.textContent = requesterUsername;

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = "Accept";
            acceptBtn.onclick = () => acceptFriendRequest(doc.id, requesterUsername);

            div.appendChild(acceptBtn);
            friendRequestsDiv.appendChild(div);
          });
        })
        .catch(err => {
          console.error("Error loading friend requests:", err);
          friendRequestsDiv.innerHTML = "<p>Error loading friend requests.</p>";
        });
    }

    function acceptFriendRequest(requestDocId, requesterUsername) {
      db.collection("friends")
        .doc(requestDocId)
        .update({ accepted: true })
        .then(() => {
          // Add reciprocal friendship for mutual friendship
          return db.collection("friends").add({
            user: currentUser,
            friend: requesterUsername,
            accepted: true
          });
        })
        .then(() => {
          alert("Friend request accepted!");
          loadFriendRequests();
          loadFriends();
        })
        .catch(err => {
          console.error("Error accepting friend request:", err);
          alert("Failed to accept friend request.");
        });
    }

    function openChatWith(friendUsername) {
      localStorage.setItem("chatWith", friendUsername);
      window.location.href = "chat.html";
    }

    function goToAddFriends() {
      window.location.href = "add-friends.html";
    }

    function logout() {
      localStorage.removeItem("username");
      localStorage.removeItem("chatWith");
      window.location.href = "index.html";
    }

    // Initial load
    loadFriends();
    loadFriendRequests();
  </script>
</body>
</html>
