<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="username-display"></span>!</h2>

    <div class="top-buttons">
      <button onclick="goToAddFriends()">âž• Add Friends</button>
      <button onclick="logout()" class="logout">Logout</button>
    </div>

    <h3>Your Friends</h3>
    <ul id="friend-list"></ul>
  </div>

  <script type="module">
    import { db, auth, signOut } from './firebase-config.js';
    import {
      collection,
      getDocs,
      getDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";

    const uid = localStorage.getItem("uid");
    const name = localStorage.getItem("name");

    if (!uid) {
      alert("You are not logged in.");
      window.location.href = "login.html";
    }

    document.getElementById("username-display").textContent = name;

    const friendList = document.getElementById("friend-list");

    async function loadFriends() {
      friendList.innerHTML = ""; // Clear existing list

      const friendsRef = collection(db, "users", uid, "friends");
      const snapshot = await getDocs(friendsRef);

      if (snapshot.empty) {
        friendList.innerHTML = "<li>You have no friends yet.</li>";
        return;
      }

      for (const friendDoc of snapshot.docs) {
        const friendId = friendDoc.id;

        const userDoc = await getDoc(doc(db, "users", friendId));
        const friendName = userDoc.exists() ? userDoc.data().name : friendId;

        const li = document.createElement("li");
        li.textContent = friendName;
        li.onclick = () => openChatWith(friendId);
        friendList.appendChild(li);
      }
    }

    function openChatWith(friendId) {
      localStorage.setItem("chatWith", friendId);
      window.location.href = "chat.html";
    }

    function goToAddFriends() {
      window.location.href = "add-friends.html";
    }

    function logout() {
      signOut(auth);
      localStorage.clear();
      window.location.href = "index.html";
    }

    // Load the friend list on page load
    loadFriends();
  </script>
</body>
</html>
